{"version":3,"file":"esurksha-1.0.0.min.js","sources":["../src/config.js","../src/api.js","../src/store.js","../src/script-manager.js","../src/preference-center.js","../src/index.js","../src/banner.js"],"sourcesContent":["let CONFIG = {}\r\n\r\nexport function setConfig(config) {\r\n  CONFIG = config\r\n}\r\n\r\nexport function getConfig() {\r\n  return CONFIG\r\n}\r\n","import { getConfig } from './config.js'\r\n\r\nexport async function fetchPurposes() {\r\n  const { apiBaseUrl, tenantId, token } = getConfig()\r\n\r\n  const res = await fetch(`${apiBaseUrl}/user/consents/purposes`, {\r\n    headers: {\r\n      'Authorization': `Bearer ${token}`,\r\n      'x-tenant-id': tenantId\r\n    }\r\n  })\r\n\r\n  return res.json()\r\n}\r\n\r\nexport async function fetchUserConsents() {\r\n  const { apiBaseUrl, tenantId, token } = getConfig()\r\n\r\n  const res = await fetch(`${apiBaseUrl}/user/consents`, {\r\n    headers: {\r\n      'Authorization': `Bearer ${token}`,\r\n      'x-tenant-id': tenantId\r\n    }\r\n  })\r\n\r\n  return res.json()\r\n}\r\n\r\nexport async function submitConsent(code, granted) {\r\n  const { apiBaseUrl, tenantId, token } = getConfig()\r\n\r\n  return fetch(`${apiBaseUrl}/user/consents`, {\r\n    method: 'POST',\r\n    headers: {\r\n      'Authorization': `Bearer ${token}`,\r\n      'x-tenant-id': tenantId,\r\n      'Content-Type': 'application/json'\r\n    },\r\n    body: JSON.stringify({\r\n      consentCode: code,\r\n      granted\r\n    })\r\n  })\r\n}\r\n","let CONSENTS = []\r\n\r\nexport function saveConsents(consents) {\r\n  CONSENTS = consents\r\n}\r\n\r\nexport function getConsents() {\r\n  return CONSENTS\r\n}\r\n\r\nexport function hasConsent(code) {\r\n  const c = CONSENTS.find(c => c.code === code)\r\n  return !!(\r\n    c &&\r\n    c.consent_given === true &&\r\n    !c.revoked_at\r\n  )\r\n}\r\n","import { hasConsent } from './store.js'\r\n\r\nexport function runConsentScripts() {\r\n  const scripts = document.querySelectorAll(\r\n    'script[type=\"text/plain\"][data-es-consent]'\r\n  )\r\n\r\n  scripts.forEach(script => {\r\n    const purposeCode = script.dataset.esConsent\r\n\r\n    if (!hasConsent(purposeCode)) {\r\n      return\r\n    }\r\n\r\n    const newScript = document.createElement('script')\r\n\r\n    // Copy attributes\r\n    Array.from(script.attributes).forEach(attr => {\r\n      if (attr.name !== 'type') {\r\n        newScript.setAttribute(attr.name, attr.value)\r\n      }\r\n    })\r\n\r\n    newScript.src = script.src\r\n    newScript.async = true\r\n\r\n    script.parentNode.replaceChild(newScript, script)\r\n  })\r\n}\r\n","import { fetchPurposes, fetchUserConsents, submitConsent } from './api.js'\r\nimport { saveConsents, getConsents } from './store.js'\r\nimport { runConsentScripts } from './script-manager.js'\r\n\r\nlet container = null\r\n\r\nexport async function openPreferenceCenter() {\r\n  if (container) return\r\n\r\n  const purposes = await fetchPurposes()\r\n  const userConsents = await fetchUserConsents()\r\n\r\n  saveConsents(userConsents)\r\n\r\n  container = document.createElement('div')\r\n  container.style = `\r\n    position: fixed;\r\n    inset: 0;\r\n    background: rgba(0,0,0,0.6);\r\n    z-index: 999999;\r\n  `\r\n\r\n  const panel = document.createElement('div')\r\n  panel.style = `\r\n    background: white;\r\n    max-width: 500px;\r\n    margin: 5% auto;\r\n    padding: 20px;\r\n    border-radius: 8px;\r\n  `\r\n\r\n  panel.innerHTML = `\r\n    <h2>Privacy Preferences</h2>\r\n    ${purposes.map(p => {\r\n      const consent = userConsents.find(c => c.code === p.code)\r\n      const checked = consent?.consent_given ? 'checked' : ''\r\n      const disabled = p.is_mandatory ? 'disabled' : ''\r\n\r\n      return `\r\n        <div>\r\n          <label>\r\n            <input\r\n              type=\"checkbox\"\r\n              data-code=\"${p.code}\"\r\n              ${checked}\r\n              ${disabled}\r\n            />\r\n            <strong>${p.code}</strong><br/>\r\n            <small>${p.description}</small>\r\n          </label>\r\n        </div>\r\n        <hr/>\r\n      `\r\n    }).join('')}\r\n    <button id=\"es-save\">Save</button>\r\n    <button id=\"es-close\">Close</button>\r\n  `\r\n\r\n  container.appendChild(panel)\r\n  document.body.appendChild(container)\r\n\r\n  document.getElementById('es-close').onclick = close\r\n  document.getElementById('es-save').onclick = save\r\n}\r\n\r\nasync function save() {\r\n  const inputs = container.querySelectorAll('input[type=checkbox]')\r\n\r\n  for (const input of inputs) {\r\n    await submitConsent(input.dataset.code, input.checked)\r\n  }\r\n\r\n  const updated = await fetchUserConsents()\r\n  saveConsents(updated)\r\n  runConsentScripts()\r\n  close()\r\n}\r\n\r\nfunction close() {\r\n  container.remove()\r\n  container = null\r\n}\r\n","import { setConfig } from './config.js'\r\nimport { fetchPurposes, fetchUserConsents } from './api.js'\r\nimport { showBanner } from './banner.js'\r\nimport { saveConsents, getConsents } from './store.js'\r\n\r\nimport { runConsentScripts } from './script-manager.js'\r\n\r\nimport { openPreferenceCenter } from './preference-center.js'\r\n\r\nasync function init(config) {\r\n  setConfig(config)\r\n\r\n  const purposes = await fetchPurposes()\r\n  const userConsents = await fetchUserConsents()\r\n\r\n  saveConsents(userConsents)\r\n  runConsentScripts()\r\n\r\n  // Detect missing or outdated consent\r\n  const pending = purposes.filter(p => {\r\n    const consent = userConsents.find(u => u.code === p.code)\r\n    // No consent record → needs consent\r\n  if (!consent) return true\r\n\r\n  // Explicitly revoked → needs consent\r\n  if (!consent.consent_given) return true\r\n\r\n  // Version mismatch → needs re-consent\r\n  if (consent.consent_version < p.version) return true\r\n\r\n  return false\r\n  })\r\n\r\n  if (pending.length > 0) {\r\n    showBanner(pending)\r\n  }\r\n}\r\n\r\nexport default{\r\n  init,\r\n  openPreferences: openPreferenceCenter\r\n}","import { submitConsent } from './api.js'\r\nimport { runConsentScripts } from './script-manager.js'\r\n\r\n\r\nexport function showBanner(purposes) {\r\n  const banner = document.createElement('div')\r\n  banner.style = `\r\n    position: fixed;\r\n    bottom: 0;\r\n    width: 100%;\r\n    background: #111;\r\n    color: #fff;\r\n    padding: 20px;\r\n    z-index: 9999;\r\n  `\r\n\r\n  banner.innerHTML = `\r\n    <h3>Privacy Preferences</h3>\r\n    ${purposes.map(p => `\r\n      <label>\r\n        <input type=\"checkbox\" data-code=\"${p.code}\">\r\n        ${p.description}\r\n      </label><br/>\r\n    `).join('')}\r\n    <button id=\"es-save\">Save</button>\r\n  `\r\n\r\n  document.body.appendChild(banner)\r\n\r\n  document.getElementById('es-save').onclick = async () => {\r\n    const inputs = banner.querySelectorAll('input[type=checkbox]')\r\n    for (const input of inputs) {\r\n      await submitConsent(input.dataset.code, input.checked)\r\n    }\r\n    banner.remove()\r\n    runConsentScripts()\r\n  }\r\n}\r\n"],"names":["CONFIG","getConfig","async","fetchPurposes","apiBaseUrl","tenantId","token","fetch","headers","Authorization","json","fetchUserConsents","submitConsent","code","granted","method","body","JSON","stringify","consentCode","CONSENTS","saveConsents","consents","runConsentScripts","document","querySelectorAll","forEach","script","c","find","consent_given","revoked_at","hasConsent","dataset","esConsent","newScript","createElement","Array","from","attributes","attr","name","setAttribute","value","src","parentNode","replaceChild","container","save","inputs","input","checked","close","remove","init","config","setConfig","purposes","userConsents","pending","filter","p","consent","u","consent_version","version","length","banner","style","innerHTML","map","description","join","appendChild","getElementById","onclick","showBanner","openPreferences","panel","disabled","is_mandatory"],"mappings":"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"}